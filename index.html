<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0d9488">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <title>æ±æ´‹åŒ»å­¦æ¦‚è«–â…£è©¦é¨“å¯¾ç­– AIã‚¯ã‚¤ã‚ºã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', 'Inter', sans-serif; padding-bottom: 3rem; }
        .quiz-option:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .quiz-option.correct { background-color: #d1fae5 !important; border-color: #10b981 !important; }
        .quiz-option.incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; }
        .quiz-option.disabled { pointer-events: none; opacity: 0.7; }
        .modal-enter { animation: fadeIn 0.3s ease-out; }
        .modal-leave { animation: fadeOut 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-3xl">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-teal-700">æ±æ´‹åŒ»å­¦æ¦‚è«–â…£è©¦é¨“å¯¾ç­– AIã‚¯ã‚¤ã‚º</h1>
            <p class="mt-2 text-gray-600">AIãŒã‚ãªãŸã®ãŸã‚ã®ã‚ªãƒªã‚¸ãƒŠãƒ«å•é¡Œã‚’ä½œæˆã—ã¾ã™</p>
        </header>

        <!-- å„ç¨®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆHTMLæ§‹é€ ã¯å¤‰æ›´ãªã—ï¼‰ -->
        <section id="settings-section" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">ã‚¯ã‚¤ã‚ºã®è¨­å®š</h2>
            <div class="space-y-4">
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-1">å‡ºé¡Œåˆ†é‡</label>
                    <select id="category" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                        <option value="å¼è¨¼æ–¹æ³•ãƒ»å…«ç¶±å¼è¨¼">å¼è¨¼æ–¹æ³•ãƒ»å…«ç¶±å¼è¨¼</option>
                        <option value="ç—…å› è«–">ç—…å› è«–</option>
                        <option value="å››è¨º">å››è¨º</option>
                        <option value="æ°—è¡€æ´¥æ¶²å¼è¨¼">æ°—è¡€æ´¥æ¶²å¼è¨¼</option>
                        <option value="è‡“è…‘å¼è¨¼">è‡“è…‘å¼è¨¼</option>
                        <option value="äº”è‡“ã®è¤‡åˆçš„ãªç—…è¨¼">äº”è‡“ã®è¤‡åˆçš„ãªç—…è¨¼</option>
                    </select>
                </div>
                <div>
                    <label for="difficulty" class="block text-sm font-medium text-gray-700 mb-1">é›£æ˜“åº¦</label>
                    <select id="difficulty" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                        <option value="åŸºç¤">åŸºç¤</option>
                        <option value="å¿œç”¨">å¿œç”¨</option>
                        <option value="å›½å®¶è©¦é¨“ãƒ¬ãƒ™ãƒ«">å›½å®¶è©¦é¨“ãƒ¬ãƒ™ãƒ«</option>
                    </select>
                </div>
                <div>
                    <label for="num-questions" class="block text-sm font-medium text-gray-700 mb-1">å•é¡Œæ•°</label>
                    <input type="number" id="num-questions" value="5" min="1" max="10" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                </div>
            </div>
            <button id="generate-btn" class="mt-6 w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-transform transform hover:scale-105">ã‚¯ã‚¤ã‚ºä½œæˆã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </section>
        <section id="loading-section" class="hidden text-center p-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-600 mx-auto"></div>
            <p class="mt-4 text-gray-600" id="loading-message">AIãŒå•é¡Œã‚’ç”Ÿæˆä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</p>
        </section>
        <section id="error-section" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert">
            <p class="font-bold">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>
            <p id="error-message">å•é¡Œã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’å¤‰æ›´ã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</p>
        </section>
        <section id="quiz-section" class="hidden">
            <div class="flex justify-between items-center mb-4">
                 <h2 id="progress-text" class="text-lg font-semibold text-gray-700"></h2>
                 <p id="score-text" class="text-lg font-bold text-teal-600"></p>
            </div>
            <div id="question-container" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 relative"></div>
            <div id="navigation-buttons" class="mt-6 text-center"></div>
        </section>
        <section id="results-section" class="hidden text-center bg-white p-8 rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-2xl font-bold mb-4">ã‚¯ã‚¤ã‚ºçµæœ</h2>
            <p id="final-score" class="text-4xl font-bold text-teal-700 mb-2"></p>
            <p id="final-message" class="text-lg text-gray-600 mb-6"></p>
            <button id="restart-btn" class="bg-teal-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-transform transform hover:scale-105">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹</button>
        </section>
    </div>
    <div id="explanation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl p-6 md:p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto modal-enter">
            <h3 class="text-xl font-bold text-teal-800 mb-4 border-b-2 border-teal-200 pb-2">è§£èª¬</h3>
            <div id="explanation-content" class="space-y-6"></div>
            <button id="close-modal-btn" class="mt-6 w-full bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition">é–‰ã˜ã‚‹</button>
        </div>
    </div>
    <div id="dispute-response-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div id="dispute-modal-content" class="bg-white rounded-xl shadow-2xl p-6 md:p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto modal-enter">
            <h3 class="text-xl font-bold text-red-800 mb-4 border-b-2 border-red-200 pb-2">AIã«ã‚ˆã‚‹å†åˆ¤å®š</h3>
            <div id="dispute-response-content" class="space-y-4"></div>
            <button id="close-dispute-modal-btn" class="mt-6 w-full bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition">é–‰ã˜ã‚‹</button>
        </div>
    </div>
    <footer class="fixed bottom-4 right-4 text-xs text-gray-400">&copy;2025 MSOM Yokamon</footer>

    <script type="module">
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’ç®¡ç†
        const state = {
            quizData: [],
            currentQuestionIndex: 0,
            score: 0,
            isLoading: false,
        };

        const sections = {
            settings: document.getElementById('settings-section'),
            loading: document.getElementById('loading-section'),
            quiz: document.getElementById('quiz-section'),
            results: document.getElementById('results-section'),
            error: document.getElementById('error-section'),
        };
        const elements = {
            generateBtn: document.getElementById('generate-btn'),
            restartBtn: document.getElementById('restart-btn'),
            categorySelect: document.getElementById('category'),
            difficultySelect: document.getElementById('difficulty'),
            numQuestionsInput: document.getElementById('num-questions'),
            progressText: document.getElementById('progress-text'),
            scoreText: document.getElementById('score-text'),
            questionContainer: document.getElementById('question-container'),
            navigationButtons: document.getElementById('navigation-buttons'),
            finalScore: document.getElementById('final-score'),
            finalMessage: document.getElementById('final-message'),
            errorMessage: document.getElementById('error-message'),
            explanationModal: document.getElementById('explanation-modal'),
            modalContent: document.getElementById('modal-content'),
            explanationContent: document.getElementById('explanation-content'),
            closeModalBtn: document.getElementById('close-modal-btn'),
            disputeResponseModal: document.getElementById('dispute-response-modal'),
            disputeModalContent: document.getElementById('dispute-modal-content'),
            disputeResponseContent: document.getElementById('dispute-response-content'),
            closeDisputeModalBtn: document.getElementById('close-dispute-modal-btn'),
            loadingMessage: document.getElementById('loading-message'),
        };

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        elements.generateBtn.addEventListener('click', generateQuiz);
        elements.restartBtn.addEventListener('click', restartQuiz);
        elements.closeModalBtn.addEventListener('click', closeExplanationModal);
        elements.closeDisputeModalBtn.addEventListener('click', closeDisputeResponseModal);
        elements.explanationModal.addEventListener('click', (e) => (e.target === elements.explanationModal) && closeExplanationModal());
        elements.disputeResponseModal.addEventListener('click', (e) => (e.target === elements.disputeResponseModal) && closeDisputeResponseModal());

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function showSection(sectionName) {
            Object.values(sections).forEach(section => section.classList.add('hidden'));
            if (sections[sectionName]) sections[sectionName].classList.remove('hidden');
        }
        
        // ä¸æ­£ãªJSONã‚’ä¿®æ­£ã—ã¦è§£æã™ã‚‹é–¢æ•°
        function sanitizeAndParseJson(jsonString) {
            const sanitizedString = jsonString.replace(/,(\s*[}\]])/g, '$1');
            return JSON.parse(sanitizedString);
        }

        // å¦å®šçš„ãªè¨­å•ã«ä¸‹ç·šã‚’å¼•ãé–¢æ•°
        function formatQuestionText(text) {
            if (!text) return 'å•é¡Œæ–‡ãŒã‚ã‚Šã¾ã›ã‚“';
            return text.replace(/(ãªã„|èª¤ã£ã¦ã„ã‚‹|å«ã¾ã‚Œãªã„|é©åˆ‡ã§ãªã„|ç•°ãªã‚‹)/g, '<u>$1</u>');
        }

        // é¸æŠè‚¢ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹é–¢æ•°ç¾¤
        function shuffleOptions(question) {
            if (!question.options || !question.answer) return question;
            const originalCorrectAnswerText = question.options[question.answer];
            if (!originalCorrectAnswerText) return question;

            let entries = Object.entries(question.options);

            for (let i = entries.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [entries[i], entries[j]] = [entries[j], entries[i]];
            }

            const newOptions = {};
            let newAnswerKey = '';
            const newKeys = ['A', 'B', 'C', 'D'];

            for (let i = 0; i < entries.length; i++) {
                const newKey = newKeys[i];
                const originalText = entries[i][1];
                newOptions[newKey] = originalText;
                if (originalText === originalCorrectAnswerText) {
                    newAnswerKey = newKey;
                }
            }

            question.options = newOptions;
            question.answer = newAnswerKey;

            return question;
        }

        function shuffleAllQuestions(quizData) {
            if (!Array.isArray(quizData)) return [];
            return quizData.map(question => shuffleOptions(question));
        }

        async function callGenerativeAI(prompt) {
            if (window.location.hostname.endsWith('netlify.app')) {
                const functionUrl = '/.netlify/functions/generate-quiz';
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorJson;
                    try {
                        errorJson = JSON.parse(errorText);
                    } catch (e) {
                        console.error("Non-JSON error response from server:", errorText);
                        throw new Error(`ã‚µãƒ¼ãƒãƒ¼ãŒäºˆæœŸã›ã¬å½¢å¼ã§å¿œç­”ã—ã¾ã—ãŸ (Status: ${response.status})ã€‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`);
                    }
                    throw new Error(errorJson.error || `ã‚µãƒ¼ãƒãƒ¼ãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã—ãŸ (Status: ${response.status})`);
                }

                const result = await response.json();
                if (result.error) { throw new Error(`${result.error}`); }
                if (result.text) { 
                    return result.text;
                } else {
                    console.error("Unexpected response structure from function:", result);
                    throw new Error("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒäºˆæœŸã—ãŸå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
                }
            } else {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvasç’°å¢ƒã§è‡ªå‹•çš„ã«æä¾›
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API error: ${response.status} ${response.statusText}. Body: ${errorBody}`);
                }
                const result = await response.json();
                if (!result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒäºˆæœŸã—ãŸå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
                }
                return result.candidates[0].content.parts[0].text;
            }
        }

        // â˜…å¤‰æ›´ç‚¹ï¼šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾ç­–ã¨ã—ã¦ã€å•é¡Œã‚’1å•ãšã¤ç”Ÿæˆã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã«å¤‰æ›´
        async function generateQuiz() {
            if (state.isLoading) return;
            state.isLoading = true;
            showSection('loading');
            sections.error.classList.add('hidden');
            state.quizData = []; // ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ

            const category = elements.categorySelect.value;
            const difficulty = elements.difficultySelect.value;
            const numQuestions = parseInt(elements.numQuestionsInput.value, 10);
            
            try {
                for (let i = 0; i < numQuestions; i++) {
                    if (elements.loadingMessage) {
                        elements.loadingMessage.textContent = `AIãŒå•é¡Œ ${i + 1} / ${numQuestions} ã‚’ç”Ÿæˆä¸­ã§ã™...`;
                    }
                    
                    let difficultyDescription = difficulty;
                    if (difficulty === "å›½å®¶è©¦é¨“ãƒ¬ãƒ™ãƒ«") {
                        difficultyDescription = "å›½å®¶è©¦é¨“ãƒ¬ãƒ™ãƒ«ï¼ˆç‰¹ã«ã€è¤‡æ•°ã®çŸ¥è­˜ã‚’çµ±åˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹è‡¨åºŠå¿œç”¨å•é¡Œã‚„ã€é‘‘åˆ¥ãŒé›£ã—ã„é«˜åº¦ãªé›£å•ï¼‰";
                    }

                    // â˜…å¤‰æ›´ç‚¹ï¼šä»¥å‰ã®å•é¡Œãƒªã‚¹ãƒˆã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«è¿½åŠ 
                    const previousQuestions = state.quizData.map(q => `- ${q.question}`).join('\n');
                    const previousQuestionsPrompt = previousQuestions ? `\n\n## éå»ã«å‡ºé¡Œã•ã‚ŒãŸå•é¡Œï¼ˆã“ã‚Œã‚‰ã¨é‡è¤‡ã—ãªã„ã“ã¨ï¼‰\n${previousQuestions}` : "";

                    // 1å•ã ã‘ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«AIã«æŒ‡ç¤ºã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
                    const prompt = `
# å‘½ä»¤æ›¸
ã‚ãªãŸã¯ã€æ±æ´‹åŒ»å­¦ã®æ•™è‚²ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä½œæˆã‚’å°‚é–€ã¨ã™ã‚‹ã€æ¥µã‚ã¦å³æ ¼ã‹ã¤å„ªç§€ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ä»¥ä¸‹ã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã¨ã€çµ¶å¯¾å³å®ˆãƒ«ãƒ¼ãƒ«ã€‘ã«å¾“ã„ã€é«˜å“è³ªãª4æŠå•é¡Œã‚’ã€1ã¤ã ã‘ã€‘ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

## çµ¶å¯¾å³å®ˆãƒ«ãƒ¼ãƒ«
1.  ç”Ÿæˆã™ã‚‹å•é¡Œã¯ã€æŒ‡å®šã•ã‚ŒãŸã€ä¸»è¦ãƒ†ãƒ¼ãƒã€‘ã«å³å¯†ã«é–¢é€£ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
2.  æç¤ºã•ã‚ŒãŸã€éå»ã«å‡ºé¡Œã•ã‚ŒãŸå•é¡Œã€‘ã®ãƒªã‚¹ãƒˆã‚’ç¢ºèªã—ã€ãã‚Œã‚‰ã¨ã¯ç•°ãªã‚‹ã€æ–°ã—ã„è¦–ç‚¹ã‚„å†…å®¹ã®å•é¡Œã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

## æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹
1.  **ã‚¹ãƒ†ãƒƒãƒ—1: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è€ƒæ¡ˆã€‚** æŒ‡å®šã•ã‚ŒãŸãƒ†ãƒ¼ãƒã€é›£æ˜“åº¦ã€ãŠã‚ˆã³éå»ã®å•é¡Œãƒªã‚¹ãƒˆã«åŸºã¥ãã€æ–°ã—ã„ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªå•é¡Œã‚’ã€1å•åˆ†ã ã‘ã€‘è€ƒæ¡ˆã—ã¾ã™ã€‚
2.  **ã‚¹ãƒ†ãƒƒãƒ—2: JSONã®æ§‹ç¯‰ã€‚** è€ƒæ¡ˆã—ãŸå†…å®¹ã‚’ã€æŒ‡å®šã•ã‚ŒãŸå³æ ¼ãªJSONå½¢å¼ã«æ²¿ã£ã¦ä¸å¯§ã«çµ„ã¿ç«‹ã¦ã¾ã™ã€‚
3.  **ã‚¹ãƒ†ãƒƒãƒ—3: å¾¹åº•çš„ãªè‡ªå·±æ¤œè¨¼ã€‚** å‡ºåŠ›ã™ã‚‹ç›´å‰ã«ã€JSONã®æ§‹æ–‡ã¨å†…å®¹ã®å®Œå…¨æ€§ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚
4.  **ã‚¹ãƒ†ãƒƒãƒ—4: æœ€çµ‚å‡ºåŠ›ã€‚** å®Œæˆã—ãŸJSONé…åˆ—ï¼ˆè¦ç´ ãŒ1ã¤ã®é…åˆ—ï¼‰ã‚’å˜ä¸€ã®jsonãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§å›²ã‚“ã§å‡ºåŠ›ã—ã¾ã™ã€‚

## ç”Ÿæˆã‚¿ã‚¹ã‚¯
* **ä¸»è¦ãƒ†ãƒ¼ãƒ:** ${category}
* **é›£æ˜“åº¦:** ${difficultyDescription}
* **å•é¡Œæ•°:** 1
${previousQuestionsPrompt}

## å³æ ¼ãªå‡ºåŠ›å½¢å¼
\`\`\`json
[
  {
    "question": "å•é¡Œæ–‡ã‚’ã“ã“ã«è¨˜è¿°ã—ã¾ã™ã€‚",
    "options": { "A": "...", "B": "...", "C": "...", "D": "..." },
    "answer": "A",
    "category": "${category}",
    "difficulty": "${difficulty}",
    "explanation": {
      "correct_reason": "...",
      "incorrect_analysis": { "B": "...", "C": "...", "D": "..." },
      "supplement": "..."
    }
  }
]
\`\`\`
`;
                    const textResponse = await callGenerativeAI(prompt);
                    const jsonMatch = textResponse.match(/```json\n([\s\S]*?)\n```/) || textResponse.match(/\[[\s\S]*\]/);
                    if (!jsonMatch) throw new Error(`AIãŒå•é¡Œ ${i + 1} ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚(Invalid format)`);
                    
                    const jsonToParse = jsonMatch[1] || jsonMatch[0];
                    const parsedJson = sanitizeAndParseJson(jsonToParse);
                    if (!Array.isArray(parsedJson) || parsedJson.length === 0) {
                        throw new Error(`AIãŒå•é¡Œ ${i + 1} ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚(Empty array)`);
                    }
                    
                    const singleQuestion = parsedJson[0];
                    state.quizData.push(singleQuestion); // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã¯æœ€å¾Œã«è¡Œã†
                }
                
                // å…¨ã¦ã®å•é¡ŒãŒæƒã£ã¦ã‹ã‚‰ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                state.quizData = shuffleAllQuestions(state.quizData);
                startQuiz();

            } catch (error) {
                console.error('Error generating quiz:', error);
                elements.errorMessage.textContent = `å•é¡Œã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'}`;
                showSection('error');
            } finally {
                state.isLoading = false;
                if (elements.loadingMessage) {
                    elements.loadingMessage.textContent = 'AIãŒå•é¡Œã‚’ç”Ÿæˆä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...';
                }
            }
        }

        function startQuiz() {
            state.currentQuestionIndex = 0;
            state.score = 0;
            showSection('quiz');
            renderQuestion();
        }

        function renderQuestion() {
            updateProgress();
            const question = state.quizData[state.currentQuestionIndex];
            if (!question) {
                elements.errorMessage.textContent = "æ¬¡ã®å•é¡Œã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
                showSection('error');
                return;
            }
            
            const formattedQuestion = formatQuestionText(question.question);
            let optionsHTML = '<p>é¸æŠè‚¢ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚</p>';

            const validOptions = ['A', 'B', 'C', 'D'];
            if (question.options && typeof question.options === 'object' && !Array.isArray(question.options)) {
                optionsHTML = validOptions.map(key => {
                    const value = question.options[key];
                    if (typeof value === 'string') {
                        return `
                            <button class="quiz-option w-full text-left p-4 border-2 border-gray-200 rounded-lg bg-gray-50 hover:bg-teal-50 transition duration-200" data-option="${key}">
                                <span class="font-bold mr-2">${key}.</span>
                                <span>${value}</span>
                            </button>
                        `;
                    }
                    return ''; 
                }).join('');
            }
            
            elements.questionContainer.innerHTML = `
                <div id="dispute-loading-overlay" class="hidden absolute top-0 left-0 right-0 bottom-0 bg-white bg-opacity-80 flex items-center justify-center z-10">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-red-600"></div>
                </div>
                <p class="text-sm text-gray-500 mb-2">${question.category || 'ä¸€èˆ¬'} / ${question.difficulty || 'æ¨™æº–'}</p>
                <p class="text-xl font-semibold mb-6">${formattedQuestion}</p>
                <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${optionsHTML}
                </div>
            `;
            
            elements.questionContainer.querySelectorAll('.quiz-option').forEach(button => {
                button.addEventListener('click', handleAnswer);
            });
            
            elements.navigationButtons.innerHTML = '';
        }
        
        function handleAnswer(event) {
            const selectedButton = event.currentTarget;
            const selectedOption = selectedButton.dataset.option;
            const question = state.quizData[state.currentQuestionIndex];
            const isCorrect = selectedOption === question.answer;

            if (isCorrect) {
                state.score++;
                selectedButton.classList.add('correct');
            } else {
                selectedButton.classList.add('incorrect');
                const correctButton = document.querySelector(`.quiz-option[data-option="${question.answer}"]`);
                if(correctButton) correctButton.classList.add('correct');
            }
            updateProgress();
            document.querySelectorAll('.quiz-option').forEach(button => button.classList.add('disabled'));
            showNavigationButtons();
        }

        function showNavigationButtons() {
            const isLastQuestion = state.currentQuestionIndex === state.quizData.length - 1;
            const nextButtonText = isLastQuestion ? 'çµæœã‚’è¦‹ã‚‹' : 'æ¬¡ã®å•é¡Œã¸';
            
            elements.navigationButtons.innerHTML = `
                <div class="flex justify-center items-center gap-4 mb-6">
                    <button id="show-explanation-btn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition">è§£èª¬ã‚’è¦‹ã‚‹</button>
                    <button id="next-question-btn" class="bg-teal-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-700 transition">${nextButtonText}</button>
                    <button id="open-dispute-form-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition ml-8">ä¸æœç”³ã—ç«‹ã¦</button>
                </div>
                <div id="dispute-section" class="hidden mt-6 border-t border-gray-200 pt-4">
                    <p class="text-sm text-gray-600 mb-2">å•é¡Œã«èª¤ã‚ŠãŒã‚ã‚‹ã¨æ€ã‚ã‚Œã‚‹å ´åˆã¯ã€ã“ã¡ã‚‰ã‹ã‚‰ã”æŒ‡æ‘˜ãã ã•ã„ã€‚</p>
                    <textarea id="dispute-textarea" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500 focus:border-red-500 transition" placeholder="å…·ä½“çš„ãªé–“é•ã„ã®ç®‡æ‰€ã‚„ã€æ­£ã—ã„ã¨æ€ã‚ã‚Œã‚‹å†…å®¹ã‚’ã”è¨˜å…¥ãã ã•ã„ã€‚"></textarea>
                    <button id="submit-dispute-btn" class="mt-2 w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition">
                        ç”³ã—ç«‹ã¦ã‚’é€ä¿¡ã™ã‚‹
                    </button>
                </div>
            `;

            document.getElementById('show-explanation-btn').addEventListener('click', openExplanationModal);
            document.getElementById('next-question-btn').addEventListener('click', () => {
                if (isLastQuestion) showResults();
                else {
                    state.currentQuestionIndex++;
                    renderQuestion();
                }
            });
            const openDisputeBtn = document.getElementById('open-dispute-form-btn');
            openDisputeBtn.addEventListener('click', () => {
                document.getElementById('dispute-section').classList.remove('hidden');
                openDisputeBtn.classList.add('hidden');
            });
            document.getElementById('submit-dispute-btn').addEventListener('click', handleDispute);
        }

        async function handleDispute() {
            const disputeText = document.getElementById('dispute-textarea').value;
            if (!disputeText.trim()) {
                alert('ä¸æœç”³ã—ç«‹ã¦ã®å†…å®¹ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const loadingOverlay = elements.questionContainer.querySelector('#dispute-loading-overlay');
            if (loadingOverlay) loadingOverlay.classList.remove('hidden');

            const question = state.quizData[state.currentQuestionIndex];
            const disputePrompt = `
# å‘½ä»¤æ›¸
ã‚ãªãŸã¯ã€æ±æ´‹åŒ»å­¦ã®æ¨©å¨ã‚ã‚‹å°‚é–€å®¶ã§ã‚ã‚Šã€å…¬å¹³ãªåˆ¤å®šå“¡ã§ã™ã€‚
ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€AIãŒç”Ÿæˆã—ãŸã‚¯ã‚¤ã‚ºå•é¡Œã«å¯¾ã—ã¦ã€Œä¸æœç”³ã—ç«‹ã¦ã€ã‚’è¡Œã„ã¾ã—ãŸã€‚
ã‚ãªãŸã®ã‚¿ã‚¹ã‚¯ã¯ã€æç¤ºã•ã‚ŒãŸå•é¡Œã€æ­£è§£ã€è§£èª¬ã€ãã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸»å¼µã‚’å³å¯†ã«åˆ†æã—ã€æœ€çµ‚çš„ãªåˆ¤å®šã‚’ä¸‹ã™ã“ã¨ã§ã™ã€‚

## åˆ¤å®šãƒ—ãƒ­ã‚»ã‚¹
1.  **å®¢è¦³çš„åˆ†æ:** ã¾ãšã€æç¤ºã•ã‚ŒãŸã€å…ƒã®ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã€‘ã‚’ã€æ¨™æº–çš„ãªæ±æ´‹åŒ»å­¦ã®æ•™ç§‘æ›¸ã‚„å¤å…¸ã«åŸºã¥ã„ã¦ã€å­¦è¡“çš„ã«å†æ¤œè¨¼ã—ã¦ãã ã•ã„ã€‚
2.  **ä¸»å¼µã®æ¤œè¨:** æ¬¡ã«ã€ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸»å¼µã€‘ã‚’çœŸæ‘¯ã«æ¤œè¨ã—ã€ãã®ä¸»å¼µãŒå¦¥å½“ã§ã‚ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚
3.  **æœ€çµ‚åˆ¤å®š:** ä¸Šè¨˜ã®åˆ†æã¨æ¤œè¨ã«åŸºã¥ãã€ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®åˆ¤å®šã‚’ä¸‹ã—ã¦ãã ã•ã„ã€‚
    * **åˆ¤å®šA:ã€Œå…ƒã®å•é¡Œã¯æ­£ã—ãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸»å¼µã¯èª¤ã‚Šã§ã‚ã‚‹ã€**
    * **åˆ¤å®šB:ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸»å¼µãŒæ­£ã—ãã€å…ƒã®å•é¡Œã«èª¤ã‚ŠãŒã‚ã£ãŸã€**
    * **åˆ¤å®šC:ã€Œä¸¡è€…ã«ä¸€ç†ã‚ã‚‹ã€ã¾ãŸã¯è«–ç‚¹ãŒè¤‡é›‘ã§åˆ¥ã®è§£èª¬ãŒå¿…è¦ã§ã‚ã‚‹ã€**
4.  **åˆ¤å®šç†ç”±ã®è¨˜è¿°:** ãªãœãã®åˆ¤å®šã«è‡³ã£ãŸã®ã‹ã€å°‚é–€çš„ã‹ã¤è«–ç†çš„ãªæ ¹æ‹ ã‚’ã€åˆå¿ƒè€…ã«ã‚‚åˆ†ã‹ã‚Šã‚„ã™ã„è¨€è‘‰ã§ä¸å¯§ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚å…ƒã®å•é¡Œã«èª¤ã‚ŠãŒã‚ã£ãŸå ´åˆã¯ã€æ­£ã—ã„æƒ…å ±ã¨è¬ç½ªã‚’æ˜ç¢ºã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

---

## æå‡ºã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿

### ã€å…ƒã®ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã€‘
\`\`\`json
${JSON.stringify(question, null, 2)}
\`\`\`

### ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸»å¼µã€‘
"${disputeText}"

---

## ã‚ãªãŸã®æœ€çµ‚çš„ãªå›ç­”ï¼ˆã“ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼‰

### ã€æœ€çµ‚åˆ¤å®šã€‘
ï¼ˆã“ã“ã«åˆ¤å®šA, B, Cã®ã„ãšã‚Œã‹ã‚’è¨˜è¿°ï¼‰

### ã€åˆ¤å®šç†ç”±ã¨è§£èª¬ã€‘
ï¼ˆã“ã“ã«åˆ¤å®šã«è‡³ã£ãŸè©³ç´°ãªç†ç”±ã¨ã€å°‚é–€å®¶ã¨ã—ã¦ã®æœ€çµ‚çš„ãªè§£èª¬ã‚’è¨˜è¿°ï¼‰
`;
            try {
                const responseText = await callGenerativeAI(disputePrompt);
                openDisputeResponseModal(responseText);
            } catch (error) {
                alert(`å†åˆ¤å®šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            } finally {
                if (loadingOverlay) loadingOverlay.classList.add('hidden');
            }
        }
        
        function updateProgress() {
            elements.progressText.textContent = `å•é¡Œ ${state.currentQuestionIndex + 1} / ${state.quizData.length}`;
            elements.scoreText.textContent = `ã‚¹ã‚³ã‚¢: ${state.score}`;
        }
        
        function showResults() {
            const percentage = Math.round((state.score / state.quizData.length) * 100);
            elements.finalScore.textContent = `${state.score} / ${state.quizData.length} æ­£è§£ (${percentage}%)`;
            let message = '';
            if (percentage === 100) message = 'ç´ æ™´ã‚‰ã—ã„ï¼å®Œç’§ã§ã™ï¼';
            else if (percentage >= 80) message = 'å„ªç§€ã§ã™ï¼ãã®èª¿å­ã§é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚';
            else if (percentage >= 50) message = 'ã¾ãšã¾ãšã§ã™ã­ã€‚å¾©ç¿’ã§ã•ã‚‰ã«çŸ¥è­˜ã‚’å›ºã‚ã¾ã—ã‚‡ã†ã€‚';
            else message = 'ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚ç¹°ã‚Šè¿”ã—æŒ‘æˆ¦ã—ã¦ç†è§£ã‚’æ·±ã‚ã¾ã—ã‚‡ã†ï¼';
            elements.finalMessage.textContent = message;
            showSection('results');
        }

        function restartQuiz() {
            state.quizData = [];
            state.currentQuestionIndex = 0;
            state.score = 0;
            showSection('settings');
        }
        
        function openExplanationModal() {
            const question = state.quizData[state.currentQuestionIndex];
            if (!question || !question.explanation) {
                elements.explanationContent.innerHTML = `<p>ã“ã®å•é¡Œã®è§£èª¬ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
            } else {
                const { correct_reason, incorrect_analysis, supplement } = question.explanation;
                let explanationHTML = '';
                if (correct_reason) explanationHTML += `<div><h4 class="text-md font-bold text-green-700 mb-2">âœ”ï¸ æ­£è§£ã®æ ¹æ‹ </h4><p class="text-gray-700 leading-relaxed">${correct_reason}</p></div>`;
                if (incorrect_analysis && typeof incorrect_analysis === 'object') {
                    explanationHTML += `<div><h4 class="text-md font-bold text-red-700 mb-2">âŒ ä¸æ­£è§£ã®åˆ†æ</h4><ul class="space-y-2">${Object.entries(incorrect_analysis).map(([key, value]) => `<li class="pl-4 border-l-2 border-gray-200"><strong class="font-semibold">${key}:</strong> ${value}</li>`).join('')}</ul></div>`;
                }
                if (supplement) explanationHTML += `<div><h4 class="text-md font-bold text-indigo-700 mb-2">ğŸ’¡ è£œè¶³ãƒ»ç™ºå±•å­¦ç¿’</h4><p class="text-gray-700 leading-relaxed">${supplement}</p></div>`;
                elements.explanationContent.innerHTML = explanationHTML || '<p>ã“ã®å•é¡Œã®è§£èª¬ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            }
            elements.explanationModal.classList.remove('hidden');
            elements.modalContent.classList.add('modal-enter');
        }
        
        function closeExplanationModal() {
            elements.modalContent.classList.add('modal-leave');
            setTimeout(() => elements.explanationModal.classList.add('hidden'), 300);
        }

        function openDisputeResponseModal(responseText) {
            elements.disputeResponseContent.innerHTML = responseText.replace(/\n/g, '<br>');
            elements.disputeResponseModal.classList.remove('hidden');
            elements.disputeModalContent.classList.add('modal-enter');
        }
        
        function closeDisputeResponseModal() {
            elements.disputeModalContent.classList.add('modal-leave');
            setTimeout(() => elements.disputeResponseModal.classList.add('hidden'), 300);
        }

        // Service Workerã®ç™»éŒ²
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>
